---
description: ì—£ì§€ ì¼€ì´ìŠ¤ì™€ ë…¼ë¦¬ ì˜¤ë¥˜ë¥¼ ì°¾ê¸° ìœ„í•´ ë¬´ì‘ìœ„ í•¨ìˆ˜ í˜¸ì¶œ ì‹œí€€ìŠ¤ë¡œ í”„ë¡œí† ì½œ ë¶ˆë³€ì„±ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.
---

# ë¶ˆë³€ì„± í…ŒìŠ¤íŠ¸ (Invariant Testing)

## ê°œìš”

ë¶ˆë³€ì„±(invariant) í…ŒìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•˜ë©´ ë¯¸ë¦¬ ì •ì˜ëœ ì»¨íŠ¸ë™íŠ¸ì˜ ë¯¸ë¦¬ ì •ì˜ëœ í•¨ìˆ˜ í˜¸ì¶œì— ëŒ€í•œ ë¬´ì‘ìœ„ ì‹œí€€ìŠ¤ì— ëŒ€í•´ ì¼ë ¨ì˜ ë¶ˆë³€ì„± í‘œí˜„ì‹ì„ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê° í•¨ìˆ˜ í˜¸ì¶œì´ ìˆ˜í–‰ëœ í›„ ì •ì˜ëœ ëª¨ë“  ë¶ˆë³€ì„±ì´ ì–´ì„¤ì…˜(asserted)ë©ë‹ˆë‹¤.

ë¶ˆë³€ì„± í…ŒìŠ¤íŠ¸ëŠ” í”„ë¡œí† ì½œì˜ ë¶€ì •í™•í•œ ë¡œì§ì„ ë…¸ì¶œì‹œí‚¤ëŠ” ê°•ë ¥í•œ ë„êµ¬ì…ë‹ˆë‹¤. í•¨ìˆ˜ í˜¸ì¶œ ì‹œí€€ìŠ¤ê°€ ë¬´ì‘ìœ„ë¡œ ìƒì„±ë˜ê³  í¼ì§•ëœ ì…ë ¥ì´ ì‚¬ìš©ë˜ê¸° ë•Œë¬¸ì—, ë¶ˆë³€ì„± í…ŒìŠ¤íŠ¸ëŠ” ì—£ì§€ ì¼€ì´ìŠ¤ì™€ ë§¤ìš° ë³µì¡í•œ í”„ë¡œí† ì½œ ìƒíƒœì—ì„œ ì˜ëª»ëœ ê°€ì •ê³¼ ë¶€ì •í™•í•œ ë¡œì§ì„ ë“œëŸ¬ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ì¼ë°˜ ë¶ˆë³€ì„± í…ŒìŠ¤íŠ¸ ìº í˜ì¸**ì—ëŠ” `runs`ì™€ `depth`ë¼ëŠ” ë‘ ê°€ì§€ ì°¨ì›ì´ ìˆìŠµë‹ˆë‹¤:

- `runs`: í•¨ìˆ˜ í˜¸ì¶œ ì‹œí€€ìŠ¤ê°€ ìƒì„±ë˜ê³  ì‹¤í–‰ë˜ëŠ” íšŸìˆ˜ì…ë‹ˆë‹¤.
- `depth`: ì£¼ì–´ì§„ `run`ì—ì„œ ìˆ˜í–‰ë˜ëŠ” í•¨ìˆ˜ í˜¸ì¶œì˜ íšŸìˆ˜ì…ë‹ˆë‹¤. ë¶ˆë³€ì„±ì€ ê° í•¨ìˆ˜ í˜¸ì¶œ í›„ì— ì–´ì„¤ì…˜ë©ë‹ˆë‹¤. í•¨ìˆ˜ í˜¸ì¶œì´ ë¦¬ë²„íŠ¸(revert)ë˜ë”ë¼ë„ `depth` ì¹´ìš´í„°ëŠ” ì—¬ì „íˆ ì¦ê°€í•©ë‹ˆë‹¤.

**ì‹œê°„ ê¸°ë°˜ ë¶ˆë³€ì„± ìº í˜ì¸**ì€ `timeout` êµ¬ì„±(ì´ˆ ë‹¨ìœ„)ì„ ì§€ì •í•˜ì—¬ ì •ì˜í•  ìˆ˜ ìˆìœ¼ë©°, ì‹¤í–‰ íšŸìˆ˜(`runs`)ì— ê´€ê³„ì—†ì´ ì§€ì •ëœ ì‹œê°„ì´ ê²½ê³¼í•œ í›„ í…ŒìŠ¤íŠ¸ê°€ ì¢…ë£Œë˜ë„ë¡ ë³´ì¥í•©ë‹ˆë‹¤.

:::note
ë¶ˆë³€ì„± í…ŒìŠ¤íŠ¸ë¥¼ êµ¬í˜„í•  ë•Œ ê° `invariant_*` í•¨ìˆ˜ë§ˆë‹¤ ë‹¤ë¥¸ EVM ì‹¤í–‰ê¸°(executor)ê°€ ìƒì„±ë˜ë¯€ë¡œ ë™ì¼í•œ EVM ìƒíƒœì— ëŒ€í•´ ë¶ˆë³€ì„±ì´ ì–´ì„¤ì…˜ë˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ì ì„ ì¸ì‹í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤. ì¦‰, `invariant_A()`ì™€ `invariant_B()` í•¨ìˆ˜ê°€ ì •ì˜ëœ ê²½ìš° `invariant_B()`ëŠ” `invariant_A()`ì˜ EVM ìƒíƒœì— ëŒ€í•´ ì–´ì„¤ì…˜ë˜ì§€ ì•Šìœ¼ë©°(ê·¸ ë°˜ëŒ€ì˜ ê²½ìš°ë„ ë§ˆì°¬ê°€ì§€) ë…ë¦½ì ì…ë‹ˆë‹¤.

ëª¨ë“  ë¶ˆë³€ì„±ì„ ë™ì‹œì— ì–´ì„¤ì…˜í•˜ë ¤ë©´ ê·¸ë£¹í™”í•˜ì—¬ ì—¬ëŸ¬ ì‘ì—…(job)ì—ì„œ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ë‘ ê°œì˜ ì‘ì—…ì„ ì‚¬ìš©í•˜ì—¬ ëª¨ë“  ë¶ˆë³€ì„±ì„ ì–´ì„¤ì…˜í•˜ëŠ” ê²ƒì€ ë‹¤ìŒê³¼ ê°™ì´ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```Solidity
function invariant_job1() public {
   assertInvariants();
}

function invariant_job2() public {
   assertInvariants();
}

function assertInvariants() internal {
   assertEq(val1, val2);
   assertEq(val3, val4);
}
```

:::

ì´ëŸ¬í•œ ë‚´ìš©ê³¼ ë‹¤ë¥¸ ë¶ˆë³€ì„± êµ¬ì„± ì¸¡ë©´ì€ [`ì—¬ê¸°`](#configuring-invariant-test-execution)ì— ì„¤ëª…ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

Foundryì—ì„œ í‘œì¤€ í…ŒìŠ¤íŠ¸ê°€ í•¨ìˆ˜ ì´ë¦„ ì•ì— `test`ë¥¼ ë¶™ì—¬ ì‹¤í–‰ë˜ëŠ” ê²ƒê³¼ ìœ ì‚¬í•˜ê²Œ, ë¶ˆë³€ì„± í…ŒìŠ¤íŠ¸ëŠ” í•¨ìˆ˜ ì´ë¦„ ì•ì— `invariant`ë¥¼ ë¶™ì—¬ í‘œì‹œí•©ë‹ˆë‹¤(ì˜ˆ: `function invariant_A()`).

`afterInvariant()` í•¨ìˆ˜ëŠ” ê° ë¶ˆë³€ì„± ì‹¤í–‰(run)ì´ ëë‚  ë•Œ í˜¸ì¶œë˜ë©°(ì„ ì–¸ëœ ê²½ìš°), ìº í˜ì¸ í›„ ì²˜ë¦¬ë¥¼ í—ˆìš©í•©ë‹ˆë‹¤. ì´ í•¨ìˆ˜ëŠ” ìº í˜ì¸ ì§€í‘œ ë¡œê¹…(ì˜ˆ: ì„ íƒìê°€ í˜¸ì¶œëœ íšŸìˆ˜) ë° í¼ì¦ˆ ìº í˜ì¸ í›„ í…ŒìŠ¤íŠ¸(ì˜ˆ: ëª¨ë“  í¬ì§€ì…˜ì„ ë‹«ê³  ëª¨ë“  ìê¸ˆì´ ì‹œìŠ¤í…œì—ì„œ ë¹ ì ¸ë‚˜ê°ˆ ìˆ˜ ìˆëŠ”ì§€ í™•ì¸)ì— ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ìŠ¤í† ë¦¬ì§€ ì¸ì‹ í¼ì¦ˆ ì…ë ¥ (Storage Aware Fuzz Inputs)

FoundryëŠ” ì´ì œ ë¶ˆë³€ì„± í…ŒìŠ¤íŠ¸ ì¤‘ì— í˜•ì‹í™”ëœ ìŠ¤í† ë¦¬ì§€ ê°’ì„ ìƒ˜í”Œë§í•˜ì—¬ ë” ì§€ëŠ¥ì ì¸ í…ŒìŠ¤íŠ¸ ì…ë ¥ì„ ìƒì„±í•˜ëŠ” ê¸°ëŠ¥ì„ ì§€ì›í•©ë‹ˆë‹¤. ì´ ê¸°ëŠ¥ì€ ì»¨íŠ¸ë™íŠ¸ ìŠ¤í† ë¦¬ì§€ ë ˆì´ì•„ì›ƒì„ í™œìš©í•˜ì—¬ ìŠ¤í† ë¦¬ì§€ ë³€ìˆ˜ì˜ íƒ€ì…ì„ ì´í•´í•˜ê³  í•´ë‹¹ íƒ€ì…ì„ ê¸°ë°˜ìœ¼ë¡œ ì ì ˆí•œ ê°’ì„ ìƒ˜í”Œë§í•©ë‹ˆë‹¤.

:::tip
ì´ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ìŠ¤í† ë¦¬ì§€ ë ˆì´ì•„ì›ƒ ì¶œë ¥ì„ í™œì„±í™”í•´ì•¼ í•©ë‹ˆë‹¤. ë‘ ê°€ì§€ ë°©ë²•ìœ¼ë¡œ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

- `foundry.toml` íŒŒì¼ì—ì„œ: `extra_output = ["storageLayout"]`
- CLI í”Œë˜ê·¸ ì‚¬ìš©: `--extra-output storageLayout`

:::

ì´ ê¸°ëŠ¥ì€ ë‹¤ìŒê³¼ ê°™ì€ ë°©ì‹ìœ¼ë¡œ ë¶ˆë³€ì„± í…ŒìŠ¤íŠ¸ë¥¼ ê°œì„ í•©ë‹ˆë‹¤:

- **íƒ€ì… ì¸ì‹ ê°’ ìƒì„±**: ì›ì‹œ ë¬´ì‘ìœ„ ê°’ì„ ì‚¬ìš©í•˜ëŠ” ëŒ€ì‹  í¼ì €(fuzzer)ê°€ ìŠ¤í† ë¦¬ì§€ ë³€ìˆ˜ì˜ ì˜ˆìƒ íƒ€ì…ê³¼ ì¼ì¹˜í•˜ëŠ” ê°’ì„ ìƒì„±í•˜ì—¬ ë” ì˜ë¯¸ ìˆëŠ” í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì´ë•ë‹ˆë‹¤.
- **ìŠ¤í† ë¦¬ì§€ ì¢…ì† ì½”ë“œ ê²½ë¡œì˜ ë” ë‚˜ì€ ì»¤ë²„ë¦¬ì§€**: ìŠ¤í† ë¦¬ì§€ë¥¼ ìˆ˜ì •í•˜ì§€ë§Œ ê°’ì„ ë°˜í™˜í•˜ê±°ë‚˜ ì´ë²¤íŠ¸ë¥¼ ë°œìƒì‹œí‚¤ì§€ ì•ŠëŠ” í•¨ìˆ˜ë¥¼ í…ŒìŠ¤íŠ¸í•  ë•Œ íŠ¹íˆ ìœ ìš©í•©ë‹ˆë‹¤. í¼ì €ê°€ ì´ëŸ¬í•œ í•¨ìˆ˜ì˜ íš¨ê³¼ë¥¼ ë” ì˜ ì´í•´í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

### ì»¤ë²„ë¦¬ì§€ ê¸°ë°˜ í¼ì§• (Coverage-Guided Fuzzing)

Foundry v1.3.0ë¶€í„° ë¶ˆë³€ì„± í…ŒìŠ¤íŠ¸ëŠ” ì´ì „ì— í…ŒìŠ¤íŠ¸ëœ í˜¸ì¶œ ì‹œí€€ìŠ¤ë¥¼ ì €ì¥í•˜ê³  ë³€í˜•í•˜ëŠ” ì»¤ë²„ë¦¬ì§€ ê¸°ë°˜ í¼ì§• ì§€ì›ê³¼ í•¨ê»˜ ì œê³µë©ë‹ˆë‹¤. ì´ ëª¨ë“œëŠ” `corpus_dir` êµ¬ì„±ì„ ì„¤ì •í•˜ì—¬ í™œì„±í™”í•  ìˆ˜ ìˆìœ¼ë©°, ì´ëŠ” ìƒˆë¡œìš´ ì»¤ë²„ë¦¬ì§€ë¥¼ ìƒì„±í•˜ëŠ” ì½”í¼ìŠ¤(corpus)ë¥¼ ì§€ì†ì‹œí‚¤ê¸° ìœ„í•´ ì‚¬ìš©ë˜ëŠ” ë””ìŠ¤í¬ ê²½ë¡œì…ë‹ˆë‹¤. ê° ì½”í¼ìŠ¤ëŠ” ê³ ìœ  IDë¡œ ì‹ë³„ë˜ë©° ê° í˜¸ì¶œì— ëŒ€í•œ í•­ëª©(ë°œì‹ ì ì£¼ì†Œ, ëŒ€ìƒ ì£¼ì†Œ ë° í˜¸ì¶œ ë°ì´í„°)ê³¼ í•¨ê»˜ JSON í˜•ì‹ìœ¼ë¡œ ì§€ì†ë©ë‹ˆë‹¤:

```json
[
  {
    "sender": "0x5cb738dae833ec21fe65ae1719fad8ab8ce7f23d",
    "call_details": {
      "target": "0x7fa9385be102ac3eac297483dd6233d62b3e1496",
      "calldata": "0xa8ad0bac000...."
    }
  },
  {
    "sender": "0x7fa9385be102ac3eac297483dd6233d62b3e1496",
    "call_details": {
      "target": "0x7fa9385be102ac3eac297483dd6233d62b3e1496",
      "calldata": "0xd9df5397000...."
    }
  }
]
```

ë¶ˆë³€ì„± í…ŒìŠ¤íŠ¸ì˜ í›„ì† ì‹¤í–‰ì—ì„œ ì €ì¥ëœ ì½”í¼ìŠ¤ëŠ” ë””ìŠ¤í¬ì—ì„œ ë¡œë“œë˜ì–´ ë‹¤ì‹œ ì¬ìƒë©ë‹ˆë‹¤.
ì»¤ë²„ë¦¬ì§€ ê¸°ë°˜ í¼ì§• ëª¨ë“œëŠ” í•­ëª©ì„ ì¼ì • íšŸìˆ˜(ê¸°ë³¸ê°’: 5íšŒ) ë³€í˜•í•˜ê³  ìƒˆë¡œìš´ ì‹¤í–‰ ê²½ë¡œë¥¼ ë°œê²¬í•  ê°€ëŠ¥ì„±ì´ ë†’ì€ í•­ëª©ì„ ì„ í˜¸í•˜ì—¬ ìµœì†Œ ì½”í¼ìŠ¤ í¬ê¸°ë¥¼ ëª©í‘œë¡œ í•©ë‹ˆë‹¤.
í˜¸ì¶œ ì‹œí€€ìŠ¤ë¥¼ ë³€í˜•í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” 5ê°€ì§€ ì „ëµì´ ìˆìŠµë‹ˆë‹¤:

- `splice`: ë‘ ì‹œí€€ìŠ¤ë¥¼ ê²°í•©í•©ë‹ˆë‹¤.
- `interleave`: ë‘ ì‹œí€€ìŠ¤ë¥¼ ì„œë¡œ ì—®ìŠµë‹ˆë‹¤.
- `prefix`: ì‹œí€€ìŠ¤ì˜ ì‹œì‘ ë¶€ë¶„ì„ ë®ì–´ì”ë‹ˆë‹¤.
- `suffix`: ì‹œí€€ìŠ¤ì˜ ë ë¶€ë¶„ì„ ë®ì–´ì”ë‹ˆë‹¤.
- `mutate args`: ì¼ë¶€ í˜¸ì¶œ ì¸ìˆ˜ë¥¼ ë¬´ì‘ìœ„í™”í•©ë‹ˆë‹¤.

(êµ¬ì„±ëœ íšŸìˆ˜ë§Œí¼ ë³€í˜•ëœ í›„ì—ë„) ìƒˆë¡œìš´ ì»¤ë²„ë¦¬ì§€ë¥¼ ìƒì„±í•˜ì§€ ì•ŠëŠ” í˜¸ì¶œ ì‹œí€€ìŠ¤ëŠ” ë©”ëª¨ë¦¬ì—ì„œ ë°©ì¶œ(evicted)ë©ë‹ˆë‹¤. ì´ëŸ¬í•œ ë°©ì¶œì´ ë°œìƒí•˜ë©´ ì½”í¼ìŠ¤ ì •ë³´(ê³ ìœ  ID, ë³€í˜• íšŸìˆ˜ ë° ì»¤ë²„ë¦¬ì§€ ê°œì„  ì‚¬í•­)ê°€ í¬í•¨ëœ ë©”íƒ€ë°ì´í„° íŒŒì¼(JSON í˜•ì‹)ì´ ë””ìŠ¤í¬ì— ê¸°ë¡ë©ë‹ˆë‹¤.

ë©”íƒ€ë°ì´í„° íŒŒì¼ ì´ë¦„ì—ëŠ” ê³ ìœ  ì½”í¼ìŠ¤ ID, ë°©ì¶œ ì‹œê°„ ë° `-metadata.json` ì ‘ë¯¸ì‚¬ê°€ í¬í•¨ë©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ `e58a7c45-475d-4c70-ad32-9a4ef09b1d8f-1753084102-metadata.json`ì´ë©° ë‚´ìš©ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

```json
{
  "uuid": "e58a7c45-475d-4c70-ad32-9a4ef09b1d8f",
  "total_mutations": 6,
  "new_finds_produced": 2,
  "is_favored": false
}
```

ì»¤ë²„ë¦¬ì§€ ê¸°ë°˜ í¼ì§• ëª¨ë“œì—ì„œ í¼ì§• ì§„í–‰ë¥  í‘œì‹œì¤„ì—ëŠ” ëˆ„ì  ì—£ì§€(cumulative edges) ë° ê¸°ëŠ¥, ì½”í¼ìŠ¤ ìˆ˜, ì„ í˜¸(favored) í•­ëª© ìˆ˜ì— ëŒ€í•œ ì§€í‘œê°€ í‘œì‹œë©ë‹ˆë‹¤.

```bash
test/forge/invariant/StaticInvariantTest.sol:StaticInvariantTest
 â†’ invariantHealthy: [60/2000] Runs
  - cumulative edges seen: 41
  - cumulative features seen: 6
  - corpus count: 15
  - favored items: 14
```

ì§„í–‰ ìƒí™© ì—†ì´ í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜í–‰í•˜ëŠ” ê²½ìš°, ì§€í‘œëŠ” ë‹¤ìŒê³¼ ê°™ì´ json í˜•ì‹ìœ¼ë¡œ 5ì´ˆë§ˆë‹¤ ì¶œë ¥ë©ë‹ˆë‹¤:

```bash
{
  "timestamp": 1753087098,
  "invariant": "invariantHealthy",
  "metrics": {
    "cumulative_edges_seen": 26,
    "cumulative_features_seen": 2,
    "corpus_count": 25,
    "favored_items": 24
  }
}
```

ì½”í¼ìŠ¤ ì„¤ì •ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ [ë¶ˆë³€ì„± êµ¬ì„±](/config/reference/testing#invariant)ì„ ì°¸ì¡°í•˜ì„¸ìš”.

### ë¶ˆë³€ì„± í…ŒìŠ¤íŠ¸ ì‹¤í–‰ êµ¬ì„±

ë¶ˆë³€ì„± í…ŒìŠ¤íŠ¸ ì‹¤í–‰ì€ ì‚¬ìš©ìê°€ Forge êµ¬ì„± í”„ë¦¬ë¯¸í‹°ë¸Œë¥¼ í†µí•´ ì œì–´í•  ìˆ˜ ìˆëŠ” ë§¤ê°œë³€ìˆ˜ì— ì˜í•´ ê´€ë¦¬ë©ë‹ˆë‹¤. êµ¬ì„±ì€ ì „ì—­ì ìœ¼ë¡œ ë˜ëŠ” í…ŒìŠ¤íŠ¸ë³„ë¡œ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ì£¼ì œì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ ğŸ“š [`ì „ì—­ êµ¬ì„±`](/config/reference/overview) ë° ğŸ“š [`ì¸ë¼ì¸ êµ¬ì„±`](/config/reference/inline-test-config)ì„ ì°¸ì¡°í•˜ì„¸ìš”.

## ë¶ˆë³€ì„± ì •ì˜

ë¶ˆë³€ì„±ì€ í¼ì§• ìº í˜ì¸ ê³¼ì •ì—ì„œ í•­ìƒ ì°¸ì´ì–´ì•¼ í•˜ëŠ” ì¡°ê±´ ë˜ëŠ” í‘œí˜„ì‹ì…ë‹ˆë‹¤. ì¢‹ì€ ë¶ˆë³€ì„± í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸ì—ëŠ” ê°€ëŠ¥í•œ í•œ ë§ì€ ë¶ˆë³€ì„±ì´ ìˆì–´ì•¼ í•˜ë©°, ë‹¤ì–‘í•œ í”„ë¡œí† ì½œ ìƒíƒœì— ëŒ€í•´ ì„œë¡œ ë‹¤ë¥¸ í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸ë¥¼ ê°€ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë¶ˆë³€ì„± ì˜ˆì‹œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

- Uniswapì˜ ê²½ìš° _"xy=k ê³µì‹ì€ í•­ìƒ ìœ ì§€ëœë‹¤"_
- ERC-20 í† í°ì˜ ê²½ìš° _"ëª¨ë“  ì‚¬ìš©ì ì”ì•¡ì˜ í•©ì€ ì´ ê³µê¸‰ëŸ‰ê³¼ ê°™ë‹¤"_

ì•„ë˜ í‘œì— ì„¤ëª…ëœ ëŒ€ë¡œ ë¶ˆë³€ì„±ì„ ì–´ì„¤ì…˜í•˜ëŠ” ë‹¤ì–‘í•œ ë°©ë²•ì´ ìˆìŠµë‹ˆë‹¤:

<table>
<tr><th>ìœ í˜•</th><th>ì„¤ëª…</th><th>ì˜ˆì‹œ</th></tr>

<tr>

<td>ì§ì ‘ ì–´ì„¤ì…˜ (Direct assertions)</td>
<td>í”„ë¡œí† ì½œ ìŠ¤ë§ˆíŠ¸ ì»¨íŠ¸ë™íŠ¸ë¥¼ ì¡°íšŒí•˜ê³  ê°’ì´ ì˜ˆìƒê³¼ ê°™ì€ì§€ í™•ì¸í•©ë‹ˆë‹¤.</td>
<td>

```solidity
assertGe(
    token.totalAssets(),
    token.totalSupply()
)
```

</td>

</tr>

<tr>

<td>ê³ ìŠ¤íŠ¸ ë³€ìˆ˜ ì–´ì„¤ì…˜ (Ghost variable assertions)</td>
<td>í”„ë¡œí† ì½œ ìŠ¤ë§ˆíŠ¸ ì»¨íŠ¸ë™íŠ¸ë¥¼ ì¡°íšŒí•˜ê³  í…ŒìŠ¤íŠ¸ í™˜ê²½ì— ì§€ì†ëœ ê°’(ê³ ìŠ¤íŠ¸ ë³€ìˆ˜)ê³¼ ë¹„êµí•©ë‹ˆë‹¤.</td>
<td>

```solidity
assertEq(
    token.totalSupply(),
    sumBalanceOf
)
```

</td>

</tr>

<tr>

<td>ë¹„ìµœì í™” (ìˆœì§„í•œ êµ¬í˜„ ì–´ì„¤ì…˜) (Deoptimizing)</td>
<td>í”„ë¡œí† ì½œ ìŠ¤ë§ˆíŠ¸ ì»¨íŠ¸ë™íŠ¸ë¥¼ ì¡°íšŒí•˜ê³  ë™ì¼í•œ ì›í•˜ëŠ” ë¡œì§ì˜ ìˆœì§„í•˜ê³  ì¼ë°˜ì ìœ¼ë¡œ ê°€ìŠ¤ íš¨ìœ¨ì„±ì´ ë§¤ìš° ë‚®ì€ êµ¬í˜„ê³¼ ë¹„êµí•©ë‹ˆë‹¤.</td>
<td>

```solidity
assertEq(
    pool.outstandingInterest(),
    test.naiveInterest()
)
```

</td>

</tr>
</table>

### ì¡°ê±´ë¶€ ë¶ˆë³€ì„±

ë¶ˆë³€ì„±ì€ ì£¼ì–´ì§„ í¼ì§• ìº í˜ì¸ ê³¼ì •ì—ì„œ ìœ ì§€ë˜ì–´ì•¼ í•˜ì§€ë§Œ, ëª¨ë“  ìƒí™©ì—ì„œ ì°¸ì´ì–´ì•¼ í•œë‹¤ëŠ” ì˜ë¯¸ëŠ” ì•„ë‹™ë‹ˆë‹¤. íŠ¹ì • ì‹œë‚˜ë¦¬ì˜¤(ì˜ˆ: ì²­ì‚° ì¤‘)ì—ì„œ íŠ¹ì • ë¶ˆë³€ì„±ì´ ë„ì…/ì œê±°ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë¶ˆë³€ì„± ì–´ì„¤ì…˜ì— ì¡°ê±´ë¶€ ë¡œì§ì„ ë„ì…í•˜ëŠ” ê²ƒì€ ê¶Œì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì˜ëª»ëœ ì½”ë“œ ê²½ë¡œë¡œ ì¸í•´ ì˜¤íƒ(false positive)ì´ ë°œìƒí•  ê°€ëŠ¥ì„±ì´ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´:

```solidity
function invariant_example() external {
    if (protocolCondition) return;

    assertEq(val1, val2);
}
```

ì´ ìƒí™©ì—ì„œ `protocolCondition == true`ì´ë©´ ë¶ˆë³€ì„±ì€ ì „í˜€ ì–´ì„¤ì…˜ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë•Œë¡œëŠ” ì´ê²ƒì´ ì›í•˜ëŠ” ë™ì‘ì¼ ìˆ˜ ìˆì§€ë§Œ, `protocolCondition`ì´ ì˜ˆìƒì¹˜ ëª»í•˜ê²Œ ì „ì²´ í¼ì§• ìº í˜ì¸ ë™ì•ˆ ì°¸ì´ê±°ë‚˜ ì¡°ê±´ ìì²´ì— ë…¼ë¦¬ ì˜¤ë¥˜ê°€ ìˆëŠ” ê²½ìš° ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ ì´ìœ ë¡œ í•´ë‹¹ ì¡°ê±´ì— ëŒ€í•´ì„œë„ ëŒ€ì²´ ë¶ˆë³€ì„±ì„ ì •ì˜í•˜ë ¤ê³  ì‹œë„í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´:

```solidity
function invariant_example() external {
    if (protocolCondition) {
        assertLe(val1, val2);
        return;
    };

    assertEq(val1, val2);
}
```

í”„ë¡œí† ì½œ ìƒíƒœ ì „ë°˜ì— ê±¸ì³ ë‹¤ì–‘í•œ ë¶ˆë³€ì„±ì„ ì²˜ë¦¬í•˜ëŠ” ë˜ ë‹¤ë¥¸ ì ‘ê·¼ ë°©ì‹ì€ ë‹¤ì–‘í•œ ì‹œë‚˜ë¦¬ì˜¤ì— ëŒ€í•´ ì „ìš© ë¶ˆë³€ì„± í…ŒìŠ¤íŠ¸ ì»¨íŠ¸ë™íŠ¸ë¥¼ í™œìš©í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì´ëŸ¬í•œ ì‹œë‚˜ë¦¬ì˜¤ëŠ” `setUp` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¶€íŠ¸ìŠ¤íŠ¸ë©í•  ìˆ˜ ìˆì§€ë§Œ, í¼ì €ê°€ íŠ¹ì • ê²°ê³¼(ì˜ˆ: ì²­ì‚° ë°©ì§€)ë§Œ ì‚°ì¶œí•˜ë„ë¡ ë™ì‘í•˜ê²Œ ì œì–´í•˜ê¸° ìœ„í•´ _ë¶ˆë³€ì„± íƒ€ê²Ÿ(invariant targets)_ì„ í™œìš©í•˜ëŠ” ê²ƒì´ ë” ê°•ë ¥í•©ë‹ˆë‹¤.

## ë¶ˆë³€ì„± íƒ€ê²Ÿ (Invariant Targets)

**íƒ€ê²Ÿ ì»¨íŠ¸ë™íŠ¸ (Target Contracts)**: ì£¼ì–´ì§„ ë¶ˆë³€ì„± í…ŒìŠ¤íŠ¸ í¼ì§• ìº í˜ì¸ ê³¼ì •ì—ì„œ í˜¸ì¶œë  ì»¨íŠ¸ë™íŠ¸ ì§‘í•©ì…ë‹ˆë‹¤. ì´ ì»¨íŠ¸ë™íŠ¸ ì§‘í•©ì€ ê¸°ë³¸ì ìœ¼ë¡œ `setUp` í•¨ìˆ˜ì— ë°°í¬ëœ ëª¨ë“  ì»¨íŠ¸ë™íŠ¸ë¡œ ì„¤ì •ë˜ì§€ë§Œ, ë” ê³ ê¸‰ ë¶ˆë³€ì„± í…ŒìŠ¤íŠ¸ë¥¼ í—ˆìš©í•˜ë„ë¡ ì‚¬ìš©ì ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**íƒ€ê²Ÿ ë°œì‹ ì (Target Senders)**: ë¶ˆë³€ì„± í…ŒìŠ¤íŠ¸ í¼ì €ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì‹œìŠ¤í…œì˜ ì—¬ëŸ¬ í–‰ìœ„ìë¥¼ ì‹œë®¬ë ˆì´ì…˜í•˜ê¸° ìœ„í•´ í¼ì¦ˆ ìº í˜ì¸ì„ ìˆ˜í–‰í•  ë•Œ `msg.sender` ê°’ì„ ë¬´ì‘ìœ„ë¡œ ì„ íƒí•©ë‹ˆë‹¤. ì›í•˜ëŠ” ê²½ìš° `setUp` í•¨ìˆ˜ì—ì„œ ë°œì‹ ì ì§‘í•©ì„ ì‚¬ìš©ì ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**íƒ€ê²Ÿ ì¸í„°í˜ì´ìŠ¤ (Target Interfaces)**: `setUp` ì¤‘ì— ë°°í¬ë˜ì§€ ì•Šì•˜ì§€ë§Œ í¬í¬ëœ í™˜ê²½ì—ì„œ í¼ì§•ëœ ì£¼ì†Œ ë° í•´ë‹¹ í”„ë¡œì íŠ¸ ì‹ë³„ì ì§‘í•©ì…ë‹ˆë‹¤ (ì˜ˆ: `[(0x1, ["IERC20"]), (0x2, ("IOwnable"))]`). ì´ë¥¼ í†µí•´ ìœ„ì„ í”„ë¡ì‹œ(delegate proxies) ë° `create` ë˜ëŠ” `create2`ë¡œ ë°°í¬ëœ ì»¨íŠ¸ë™íŠ¸ë¥¼ íƒ€ê²ŸíŒ…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**íƒ€ê²Ÿ ì„ íƒì (Target Selectors)**: ë¶ˆë³€ì„± í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ í¼ì €ê°€ ì‚¬ìš©í•˜ëŠ” í•¨ìˆ˜ ì„ íƒì ì§‘í•©ì…ë‹ˆë‹¤. ì´ë¥¼ ì‚¬ìš©í•˜ì—¬ ì£¼ì–´ì§„ íƒ€ê²Ÿ ì»¨íŠ¸ë™íŠ¸ ë‚´ì˜ í•¨ìˆ˜ í•˜ìœ„ ì§‘í•©ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**íƒ€ê²Ÿ ì•„í‹°íŒ©íŠ¸ (Target Artifacts)**: ì£¼ì–´ì§„ ì»¨íŠ¸ë™íŠ¸ì— ì‚¬ìš©í•  ì›í•˜ëŠ” ABIì…ë‹ˆë‹¤. í”„ë¡ì‹œ ì»¨íŠ¸ë™íŠ¸ êµ¬ì„±ì— ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**íƒ€ê²Ÿ ì•„í‹°íŒ©íŠ¸ ì„ íƒì (Target Artifact Selectors)**: ì£¼ì–´ì§„ ì»¨íŠ¸ë™íŠ¸ì— ì‚¬ìš©í•  ì£¼ì–´ì§„ ABI ë‚´ì—ì„œ ì‚¬ìš©í•  ì›í•˜ëŠ” í•¨ìˆ˜ ì„ íƒì í•˜ìœ„ ì§‘í•©ì…ë‹ˆë‹¤. í”„ë¡ì‹œ ì»¨íŠ¸ë™íŠ¸ êµ¬ì„±ì— ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

íƒ€ê²Ÿ ì¶©ëŒ ì‹œ ë¶ˆë³€ì„± í¼ì €ì˜ ìš°ì„ ìˆœìœ„ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

`targetInterfaces | targetSelectors > excludeSelectors | targetArtifactSelectors > excludeContracts | excludeArtifacts > targetContracts | targetArtifacts`

### í•¨ìˆ˜ í˜¸ì¶œ í™•ë¥  ë¶„í¬

ì´ëŸ¬í•œ ì»¨íŠ¸ë™íŠ¸ì˜ í•¨ìˆ˜ëŠ” í¼ì§•ëœ ì…ë ¥ê³¼ í•¨ê»˜ ë¬´ì‘ìœ„ë¡œ(ê· ë“±í•˜ê²Œ ë¶„í¬ëœ í™•ë¥ ë¡œ) í˜¸ì¶œë©ë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´:

```text
targetContract1:
â”œâ”€ function1: 20%
â””â”€ function2: 20%

targetContract2:
â”œâ”€ function1: 20%
â”œâ”€ function2: 20%
â””â”€ function3: 20%
```

íƒ€ê²Ÿ ì»¨íŠ¸ë™íŠ¸ë¥¼ ì„¤ê³„í•  ë•Œ ì´ ì ì„ ì—¼ë‘ì— ë‘ì–´ì•¼ í•©ë‹ˆë‹¤. í•¨ìˆ˜ê°€ ì ì€ íƒ€ê²Ÿ ì»¨íŠ¸ë™íŠ¸ëŠ” ì´ í™•ë¥  ë¶„í¬ë¡œ ì¸í•´ ê° í•¨ìˆ˜ê°€ ë” ìì£¼ í˜¸ì¶œë˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

### ë¶ˆë³€ì„± í…ŒìŠ¤íŠ¸ ë„ìš°ë¯¸ í•¨ìˆ˜

ë¶ˆë³€ì„± í…ŒìŠ¤íŠ¸ ë„ìš°ë¯¸ í•¨ìˆ˜ëŠ” êµ¬ì„± ê°€ëŠ¥í•œ ë¶ˆë³€ì„± í…ŒìŠ¤íŠ¸ ì„¤ì •ì„ í—ˆìš©í•˜ê¸° ìœ„í•´ [`forge-std`](https://github.com/foundry-rs/forge-std/blob/master/src/StdInvariant.sol)ì— í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë„ìš°ë¯¸ í•¨ìˆ˜ëŠ” ì•„ë˜ì— ì„¤ëª…ë˜ì–´ ìˆìŠµë‹ˆë‹¤:

| í•¨ìˆ˜                                                                               | ì„¤ëª…                                                                                                                                                                                                                                                                                                                      |
| ---------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `excludeContract(address newExcludedContract_)`                                    | ì£¼ì–´ì§„ ì£¼ì†Œë¥¼ `_excludedContracts` ë°°ì—´ì— ì¶”ê°€í•©ë‹ˆë‹¤. ì´ ì»¨íŠ¸ë™íŠ¸ ì§‘í•©ì€ íƒ€ê²Ÿ ì»¨íŠ¸ë™íŠ¸ì—ì„œ ëª…ì‹œì ìœ¼ë¡œ ì œì™¸ë©ë‹ˆë‹¤.                                                                                                                                                                                                         |
| `excludeSelector(FuzzSelector memory newExcludedSelector_)`                        | ì£¼ì–´ì§„ `FuzzSelector`ë¥¼ `_excludedSelectors` ë°°ì—´ì— ì¶”ê°€í•©ë‹ˆë‹¤. ì´ `FuzzSelector` ì§‘í•©ì€ íƒ€ê²Ÿ ì»¨íŠ¸ë™íŠ¸ ì„ íƒìì—ì„œ ëª…ì‹œì ìœ¼ë¡œ ì œì™¸ë©ë‹ˆë‹¤.                                                                                                                                                                                  |
| `excludeSender(address newExcludedSender_)`                                        | ì£¼ì–´ì§„ ì£¼ì†Œë¥¼ `_excludedSenders` ë°°ì—´ì— ì¶”ê°€í•©ë‹ˆë‹¤. ì´ ì£¼ì†Œ ì§‘í•©ì€ íƒ€ê²Ÿ ë°œì‹ ìì—ì„œ ëª…ì‹œì ìœ¼ë¡œ ì œì™¸ë©ë‹ˆë‹¤.                                                                                                                                                                                                                 |
| `excludeArtifact(string memory newExcludedArtifact_)`                              | ì£¼ì–´ì§„ ë¬¸ìì—´ì„ `_excludedArtifacts` ë°°ì—´ì— ì¶”ê°€í•©ë‹ˆë‹¤. ì´ ë¬¸ìì—´ ì§‘í•©ì€ íƒ€ê²Ÿ ì•„í‹°íŒ©íŠ¸ì—ì„œ ëª…ì‹œì ìœ¼ë¡œ ì œì™¸ë©ë‹ˆë‹¤.                                                                                                                                                                                                         |
| `targetArtifact(string memory newTargetedArtifact_)`                               | ì£¼ì–´ì§„ ë¬¸ìì—´ì„ `_targetedArtifacts` ë°°ì—´ì— ì¶”ê°€í•©ë‹ˆë‹¤. ì´ ë¬¸ìì—´ ì§‘í•©ì€ íƒ€ê²Ÿ ì•„í‹°íŒ©íŠ¸ì— ì‚¬ìš©ë©ë‹ˆë‹¤.                                                                                                                                                                                                                      |
| `targetArtifactSelector(FuzzArtifactSelector memory newTargetedArtifactSelector_)` | ì£¼ì–´ì§„ `FuzzArtifactSelector`ë¥¼ `_targetedArtifactSelectors` ë°°ì—´ì— ì¶”ê°€í•©ë‹ˆë‹¤. ì´ `FuzzArtifactSelector` ì§‘í•©ì€ íƒ€ê²Ÿ ì•„í‹°íŒ©íŠ¸ ì„ íƒìì— ì‚¬ìš©ë©ë‹ˆë‹¤.                                                                                                                                                                       |
| `targetContract(address newTargetedContract_)`                                     | ì£¼ì–´ì§„ ì£¼ì†Œë¥¼ `_targetedContracts` ë°°ì—´ì— ì¶”ê°€í•©ë‹ˆë‹¤. ì´ ì£¼ì†Œ ì§‘í•©ì€ íƒ€ê²Ÿ ì»¨íŠ¸ë™íŠ¸ì— ì‚¬ìš©ë©ë‹ˆë‹¤. ì´ ë°°ì—´ì€ `setUp` ì¤‘ì— ë°°í¬ëœ ì»¨íŠ¸ë™íŠ¸ ì§‘í•©ì„ ë®ì–´ì”ë‹ˆë‹¤.                                                                                                                                                                |
| `targetSelector(FuzzSelector memory newTargetedSelector_)`                         | ì£¼ì–´ì§„ `FuzzSelector`ë¥¼ `_targetedSelectors` ë°°ì—´ì— ì¶”ê°€í•©ë‹ˆë‹¤. ì´ `FuzzSelector` ì§‘í•©ì€ íƒ€ê²Ÿ ì»¨íŠ¸ë™íŠ¸ ì„ íƒìì— ì‚¬ìš©ë©ë‹ˆë‹¤.                                                                                                                                                                                               |
| `targetSender(address newTargetedSender_)`                                         | ì£¼ì–´ì§„ ì£¼ì†Œë¥¼ `_targetedSenders` ë°°ì—´ì— ì¶”ê°€í•©ë‹ˆë‹¤. ì´ ì£¼ì†Œ ì§‘í•©ì€ íƒ€ê²Ÿ ë°œì‹ ìì— ì‚¬ìš©ë©ë‹ˆë‹¤.                                                                                                                                                                                                                              |
| `targetInterface(FuzzInterface memory newTargetedInterface_)`                      | ì£¼ì–´ì§„ `FuzzInterface`ë¥¼ `_targetedInterfaces` ë°°ì—´ì— ì¶”ê°€í•©ë‹ˆë‹¤. ì´ `FuzzInterface` ì§‘í•©ì€ í¼ì§•í•  ì»¨íŠ¸ë™íŠ¸ ë° ì„ íƒìë¥¼ í™•ì¥í•˜ê³ , í¬í¬ëœ í™˜ê²½ì—ì„œ í¼ì§•í•  ë•Œì™€ ê°™ì´ `setUp` ì¤‘ì— ë°°í¬ë˜ì§€ ì•Šì€ ì£¼ì†Œë¥¼ íƒ€ê²ŸíŒ…í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤. ë˜í•œ ìœ„ì„ í”„ë¡ì‹œ ë° `create` ë˜ëŠ” `create2`ë¡œ ë°°í¬ëœ ì»¨íŠ¸ë™íŠ¸ë¥¼ íƒ€ê²ŸíŒ…í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤. |

### íƒ€ê²Ÿ ì»¨íŠ¸ë™íŠ¸ ì„¤ì •

íƒ€ê²Ÿ ì»¨íŠ¸ë™íŠ¸ëŠ” ë‹¤ìŒ ì„¸ ê°€ì§€ ë°©ë²•ì„ ì‚¬ìš©í•˜ì—¬ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

1. `targetContracts` ë°°ì—´ì— ìˆ˜ë™ìœ¼ë¡œ ì¶”ê°€ëœ ì»¨íŠ¸ë™íŠ¸ëŠ” íƒ€ê²Ÿ ì»¨íŠ¸ë™íŠ¸ ì§‘í•©ì— ì¶”ê°€ë©ë‹ˆë‹¤.
2. `setUp` í•¨ìˆ˜ì— ë°°í¬ëœ ì»¨íŠ¸ë™íŠ¸ëŠ” ìë™ìœ¼ë¡œ íƒ€ê²Ÿ ì»¨íŠ¸ë™íŠ¸ ì§‘í•©ì— ì¶”ê°€ë©ë‹ˆë‹¤ (ì˜µì…˜ 1ì„ ì‚¬ìš©í•˜ì—¬ ìˆ˜ë™ìœ¼ë¡œ ì¶”ê°€ëœ ì»¨íŠ¸ë™íŠ¸ê°€ ì—†ëŠ” ê²½ìš°ì—ë§Œ ì‘ë™).
3. `setUp`ì— ë°°í¬ëœ ì»¨íŠ¸ë™íŠ¸ê°€ `excludeContracts` ë°°ì—´ì— ì¶”ê°€ë˜ë©´ íƒ€ê²Ÿ ì»¨íŠ¸ë™íŠ¸ì—ì„œ **ì œê±°**ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ì˜¤í”ˆ í…ŒìŠ¤íŠ¸ (Open Testing)

íƒ€ê²Ÿ ì»¨íŠ¸ë™íŠ¸ì˜ ê¸°ë³¸ êµ¬ì„±ì€ ì„¤ì •(setup) ì¤‘ì— ë°°í¬ëœ ëª¨ë“  ì»¨íŠ¸ë™íŠ¸ë¡œ ì„¤ì •ë©ë‹ˆë‹¤. ë” ì‘ì€ ëª¨ë“ˆê³¼ ë” ë§ì€ ì‚°ìˆ  ì»¨íŠ¸ë™íŠ¸ì˜ ê²½ìš° ì´ê²ƒì´ ì˜ ì‘ë™í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´:

```solidity
contract ExampleContract1 {

    uint256 public val1;
    uint256 public val2;
    uint256 public val3;

    function addToA(uint256 amount) external {
        val1 += amount;
        val3 += amount;
    }

    function addToB(uint256 amount) external {
        val2 += amount;
        val3 += amount;
    }

}
```

ì´ ì»¨íŠ¸ë™íŠ¸ëŠ” ê¸°ë³¸ íƒ€ê²Ÿ ì»¨íŠ¸ë™íŠ¸ íŒ¨í„´ì„ ì‚¬ìš©í•˜ì—¬ ë°°í¬í•˜ê³  í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```solidity
contract InvariantExample1 is Test {

    ExampleContract1 foo;

    function setUp() external {
        foo = new ExampleContract1();
    }

    function invariant_A() external {
        assertEq(foo.val1() + foo.val2(), foo.val3());
    }

    function invariant_B() external {
        assertGe(foo.val1() + foo.val2(), foo.val3());
    }

}
```

ì´ ì„¤ì •ì€ í¼ì§•ëœ ì…ë ¥ê³¼ í•¨ê»˜ 50%-50% í™•ë¥  ë¶„í¬ë¡œ `foo.addToA()` ë° `foo.addToB()`ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤. í•„ì—°ì ìœ¼ë¡œ ì…ë ¥ì´ ì˜¤ë²„í”Œë¡œë¥¼ ì¼ìœ¼í‚¤ê¸° ì‹œì‘í•˜ê³  í•¨ìˆ˜ í˜¸ì¶œì´ ë¦¬ë²„íŠ¸ë˜ê¸° ì‹œì‘í•  ê²ƒì…ë‹ˆë‹¤. ë¶ˆë³€ì„± í…ŒìŠ¤íŠ¸ì˜ ê¸°ë³¸ êµ¬ì„±ì€ `fail_on_revert = false`ì´ë¯€ë¡œ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë¶ˆë³€ì„±ì€ í¼ì§• ìº í˜ì¸ì˜ ë‚˜ë¨¸ì§€ ë¶€ë¶„ ë™ì•ˆ ìœ ì§€ë˜ë©° ê²°ê³¼ì ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í•©ë‹ˆë‹¤. ì¶œë ¥ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

```text
[PASS] invariant_A() (runs: 50, calls: 10000, reverts: 5533)
[PASS] invariant_B() (runs: 50, calls: 10000, reverts: 5533)
```

## í•¸ë“¤ëŸ¬ ê¸°ë°˜ í…ŒìŠ¤íŠ¸ (Handler-Based Testing)

ë” ë³µì¡í•˜ê³  í†µí•©ëœ í”„ë¡œí† ì½œì˜ ê²½ìš° ì›í•˜ëŠ” ê²°ê³¼ë¥¼ ì–»ìœ¼ë ¤ë©´ ë” ì •êµí•œ íƒ€ê²Ÿ ì»¨íŠ¸ë™íŠ¸ ì‚¬ìš©ì´ í•„ìš”í•©ë‹ˆë‹¤. í•¸ë“¤ëŸ¬ë¥¼ í™œìš©í•˜ëŠ” ë°©ë²•ì„ ì„¤ëª…í•˜ê¸° ìœ„í•´ ë‹¤ìŒ ì»¨íŠ¸ë™íŠ¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤ (ë‹¤ë¥¸ ERC-20 í† í°ì˜ ì˜ˆê¸ˆì„ í—ˆìš©í•˜ëŠ” ERC-4626 ê¸°ë°˜ ì»¨íŠ¸ë™íŠ¸):

```solidity
// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.17;

interface IERC20Like {

    function balanceOf(address owner_) external view returns (uint256 balance_);

    function transferFrom(
        address owner_,
        address recipient_,
        uint256 amount_
    ) external returns (bool success_);

}

contract Basic4626Deposit {

    /**********************************************************************************************/
    /*** Storage                                                                                ***/
    /**********************************************************************************************/

    address public immutable asset;

    string public name;
    string public symbol;

    uint8 public immutable decimals;

    uint256 public totalSupply;

    mapping(address => uint256) public balanceOf;

    /**********************************************************************************************/
    /*** Constructor                                                                            ***/
    /**********************************************************************************************/

    constructor(address asset_, string memory name_, string memory symbol_, uint8 decimals_) {
        asset    = asset_;
        name     = name_;
        symbol   = symbol_;
        decimals = decimals_;
    }

    /**********************************************************************************************/
    /*** External Functions                                                                     ***/
    /**********************************************************************************************/

    function deposit(uint256 assets_, address receiver_) external returns (uint256 shares_) {
        shares_ = convertToShares(assets_);

        require(receiver_ != address(0), "ZERO_RECEIVER");
        require(shares_   != uint256(0), "ZERO_SHARES");
        require(assets_   != uint256(0), "ZERO_ASSETS");

        totalSupply += shares_;

        // Cannot overflow because totalSupply would first overflow in the statement above.
        unchecked { balanceOf[receiver_] += shares_; }

        require(
            IERC20Like(asset).transferFrom(msg.sender, address(this), assets_),
            "TRANSFER_FROM"
        );
    }

    function transfer(address recipient_, uint256 amount_) external returns (bool success_) {
        balanceOf[msg.sender] -= amount_;

        // Cannot overflow because minting prevents overflow of totalSupply,
        // and sum of user balances == totalSupply.
        unchecked { balanceOf[recipient_] += amount_; }

        return true;
    }

    /**********************************************************************************************/
    /*** Public View Functions                                                                  ***/
    /**********************************************************************************************/

    function convertToShares(uint256 assets_) public view returns (uint256 shares_) {
        uint256 supply_ = totalSupply;  // Cache to stack.

        shares_ = supply_ == 0 ? assets_ : (assets_ * supply_) / totalAssets();
    }

    function totalAssets() public view returns (uint256 assets_) {
        assets_ = IERC20Like(asset).balanceOf(address(this));
    }

}

```

### í•¸ë“¤ëŸ¬ í•¨ìˆ˜

ì´ ì»¨íŠ¸ë™íŠ¸ì˜ `deposit` í•¨ìˆ˜ëŠ” í˜¸ì¶œìê°€ 0ì´ ì•„ë‹Œ ERC-20 `asset` ì”ì•¡ì„ ë³´ìœ í•˜ê³  ìˆì–´ì•¼ í•©ë‹ˆë‹¤. ì˜¤í”ˆ ë¶ˆë³€ì„± í…ŒìŠ¤íŠ¸ ì ‘ê·¼ ë°©ì‹ì—ì„œ `deposit()`ê³¼ `transfer()`ëŠ” 50-50% ë¶„í¬ë¡œ í˜¸ì¶œë˜ì§€ë§Œ ëª¨ë“  í˜¸ì¶œì—ì„œ ë¦¬ë²„íŠ¸ë©ë‹ˆë‹¤. ì´ë¡œ ì¸í•´ ë¶ˆë³€ì„± í…ŒìŠ¤íŠ¸ê°€ "í†µê³¼"ë˜ì§€ë§Œ ì‹¤ì œë¡œ ì›í•˜ëŠ” ì»¨íŠ¸ë™íŠ¸ì—ì„œ ìƒíƒœ ì¡°ì‘ì´ ì „í˜€ ì´ë£¨ì–´ì§€ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì—¬ê¸°ì„œ íƒ€ê²Ÿ ì»¨íŠ¸ë™íŠ¸ë¥¼ í™œìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì»¨íŠ¸ë™íŠ¸ê°€ ì œëŒ€ë¡œ ì‘ë™í•˜ê¸° ìœ„í•´ ì¶”ê°€ ë¡œì§ì´ í•„ìš”í•œ ê²½ìš° `Handler`(í•¸ë“¤ëŸ¬)ë¼ê³  í•˜ëŠ” ì „ìš© ì»¨íŠ¸ë™íŠ¸ì— ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```solidity
function deposit(uint256 assets) public virtual {
    asset.mint(address(this), assets);

    asset.approve(address(token), assets);

    uint256 shares = token.deposit(assets, address(this));
}
```

ì´ ì»¨íŠ¸ë™íŠ¸ëŠ” í•¨ìˆ˜ í˜¸ì¶œì´ ìˆ˜í–‰ë˜ê¸° ì „ì— ì„±ê³µì„ ë³´ì¥í•˜ê¸° ìœ„í•´ í•„ìš”í•œ ì„¤ì •ì„ ì œê³µí•©ë‹ˆë‹¤.

ì´ ê°œë…ì„ ë°”íƒ•ìœ¼ë¡œ í•¸ë“¤ëŸ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ë” ì •êµí•œ ë¶ˆë³€ì„± í…ŒìŠ¤íŠ¸ë¥¼ ê°œë°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜¤í”ˆ ë¶ˆë³€ì„± í…ŒìŠ¤íŠ¸ì˜ ê²½ìš° í…ŒìŠ¤íŠ¸ëŠ” ì•„ë˜ ë‹¤ì´ì–´ê·¸ë¨ê³¼ ê°™ì´ ì‹¤í–‰ë˜ë©°, ë¬´ì‘ìœ„ í•¨ìˆ˜ í˜¸ì¶œ ì‹œí€€ìŠ¤ê°€ í¼ì§•ëœ ë§¤ê°œë³€ìˆ˜ì™€ í•¨ê»˜ í”„ë¡œí† ì½œ ì»¨íŠ¸ë™íŠ¸ì— ì§ì ‘ ìˆ˜í–‰ë©ë‹ˆë‹¤. ì´ëŠ” ìœ„ì—ì„œ ì„¤ëª…í•œ ê²ƒì²˜ëŸ¼ ë” ë³µì¡í•œ ì‹œìŠ¤í…œì˜ ê²½ìš° ë¦¬ë²„íŠ¸ë¥¼ ìœ ë°œí•©ë‹ˆë‹¤.

![ë¹ˆ ë‹¤ì´ì–´ê·¸ë¨](https://user-images.githubusercontent.com/44272939/214752968-5f0e7653-d52e-43e6-b453-cac935f5d97d.svg)

ëª¨ë“  í•¸ë“¤ëŸ¬ ì»¨íŠ¸ë™íŠ¸ë¥¼ `targetContracts` ë°°ì—´ì— ìˆ˜ë™ìœ¼ë¡œ ì¶”ê°€í•˜ë©´, í”„ë¡œí† ì½œ ì»¨íŠ¸ë™íŠ¸ì— ëŒ€í•œ ëª¨ë“  í•¨ìˆ˜ í˜¸ì¶œì´ ì„±ê³µì ì¸ í˜¸ì¶œì„ ë³´ì¥í•˜ë„ë¡ í•¸ë“¤ëŸ¬ì— ì˜í•´ ê´€ë¦¬ë˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì´ë£¨ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ì•„ë˜ ë‹¤ì´ì–´ê·¸ë¨ì— ì„¤ëª…ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

![ë¶ˆë³€ì„± ë‹¤ì´ì–´ê·¸ë¨ - 2í˜ì´ì§€](https://user-images.githubusercontent.com/44272939/216420091-8a5c2bcc-d586-458f-be1e-a9ea0ef5961f.svg)

í¼ì €ì™€ í”„ë¡œí† ì½œ ì‚¬ì´ì— ì´ ê³„ì¸µì„ ë‘ë©´ ë” ê°•ë ¥í•œ í…ŒìŠ¤íŠ¸ë¥¼ ë‹¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### í•¸ë“¤ëŸ¬ ê³ ìŠ¤íŠ¸ ë³€ìˆ˜

í•¸ë“¤ëŸ¬ ë‚´ì—ì„œ "ê³ ìŠ¤íŠ¸ ë³€ìˆ˜(ghost variables)"ë¥¼ ì—¬ëŸ¬ í•¨ìˆ˜ í˜¸ì¶œì— ê±¸ì³ ì¶”ì í•˜ì—¬ ë¶ˆë³€ì„± í…ŒìŠ¤íŠ¸ì— ì¶”ê°€ ì •ë³´ë¥¼ ë”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ì— ëŒ€í•œ ì¢‹ì€ ì˜ˆëŠ” ìœ„ì—ì„œ ë³¸ ê²ƒì²˜ëŸ¼ ERC-4626 í† í°ì— ì˜ˆê¸ˆí•œ í›„ ê° LPê°€ ì†Œìœ í•œ ëª¨ë“  `shares`ë¥¼ í•©ì‚°í•˜ì—¬ ë¶ˆë³€ì„±(`totalSupply == sumBalanceOf`)ì— ì‚¬ìš©í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

```solidity
function deposit(uint256 assets) public virtual {
    asset.mint(address(this), assets);

    asset.approve(address(token), assets);

    uint256 shares = token.deposit(assets, address(this));

    sumBalanceOf += shares;
}
```

### í•¨ìˆ˜ ìˆ˜ì¤€ ì–´ì„¤ì…˜

ë˜ ë‹¤ë¥¸ ì´ì ì€ í•¨ìˆ˜ í˜¸ì¶œì´ ì¼ì–´ë‚˜ëŠ” ë™ì•ˆ ì–´ì„¤ì…˜ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ `deposit` í•¨ìˆ˜ í˜¸ì¶œ ì¤‘ì— LPì˜ ERC-20 ì”ì•¡ì´ `assets`ë§Œí¼ ê°ì†Œí•˜ê³  LP í† í° ì”ì•¡ì´ `shares`ë§Œí¼ ì¦ê°€í–ˆëŠ”ì§€ ì–´ì„¤ì…˜í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì´ëŸ° ë°©ì‹ìœ¼ë¡œ í•¸ë“¤ëŸ¬ í•¨ìˆ˜ëŠ” í¼ì§•ëœ ì…ë ¥ì„ ë°›ì•„ ìƒíƒœ ë³€ê²½ì„ ìˆ˜í–‰í•˜ê³  ì „/í›„ ìƒíƒœë¥¼ ì–´ì„¤ì…˜í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— í¼ì¦ˆ í…ŒìŠ¤íŠ¸ì™€ ìœ ì‚¬í•©ë‹ˆë‹¤.

```solidity
function deposit(uint256 assets) public virtual {
    asset.mint(address(this), assets);

    asset.approve(address(token), assets);

    uint256 beforeBalance = asset.balanceOf(address(this));

    uint256 shares = token.deposit(assets, address(this));

    assertEq(asset.balanceOf(address(this)), beforeBalance - assets);

    sumBalanceOf += shares;
}
```

### ì œí•œëœ/ì œí•œë˜ì§€ ì•Šì€ í•¨ìˆ˜ (Bounded/Unbounded Functions)

ë˜í•œ í•¸ë“¤ëŸ¬ë¥¼ ì‚¬ìš©í•˜ë©´ ì…ë ¥ ë§¤ê°œë³€ìˆ˜ë¥¼ í•©ë¦¬ì ì¸ ì˜ˆìƒ ê°’ìœ¼ë¡œ ì œí•œ(bound)í•˜ì—¬ `foundry.toml`ì˜ `fail_on_revert`ë¥¼ `true`ë¡œ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” `forge-std`ì˜ `bound()` ë„ìš°ë¯¸ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í•˜ë ¤ë©´ í¼ì €ê°€ ìˆ˜í–‰í•˜ëŠ” ëª¨ë“  í•¨ìˆ˜ í˜¸ì¶œì´ í”„ë¡œí† ì½œì— ëŒ€í•´ ì„±ê³µí•´ì•¼ í•©ë‹ˆë‹¤. ì´ëŠ” ê°€ì‹œì„±ê³¼ í”„ë¡œí† ì½œì´ ì›í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ë˜ê³  ìˆë‹¤ëŠ” í™•ì‹ ì„ ê°–ëŠ” ë° ë§¤ìš° ìœ ìš©í•©ë‹ˆë‹¤.

```solidity
function deposit(uint256 assets) external {
    assets = bound(assets, 0, 1e30);

    asset.mint(address(this), assets);

    asset.approve(address(token), assets);

    uint256 beforeBalance = asset.balanceOf(address(this));

    uint256 shares = token.deposit(assets, address(this));

    assertEq(asset.balanceOf(address(this)), beforeBalance - assets);

    sumBalanceOf += shares;
}
```

ì´ëŠ” `fail_on_revert = false` í…ŒìŠ¤íŠ¸ì— ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì „ìš© "ì œí•œë˜ì§€ ì•Šì€(unbounded)" í•¸ë“¤ëŸ¬ ì»¨íŠ¸ë™íŠ¸ì—ì„œ ì œí•œë˜ì§€ ì•Šì€ í•¨ìˆ˜ë¥¼ ìƒì†í•˜ì—¬ ìˆ˜í–‰í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ ìœ í˜•ì˜ í…ŒìŠ¤íŠ¸ëŠ” `bound` í•¨ìˆ˜ ì‚¬ìš© ì‹œ ë°œìƒí•œ ê°€ì •ì˜ ë¬¸ì œë¥¼ ë…¸ì¶œì‹œí‚¬ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ìœ ìš©í•©ë‹ˆë‹¤.

```solidity
// Unbounded
function deposit(uint256 assets) public virtual {
    asset.mint(address(this), assets);

    asset.approve(address(token), assets);

    uint256 beforeBalance = asset.balanceOf(address(this));

    uint256 shares = token.deposit(assets, address(this));

    assertEq(asset.balanceOf(address(this)), beforeBalance - assets);

    sumBalanceOf += shares;
}
```

```solidity
// Bounded
function deposit(uint256 assets) external {
    assets = bound(assets, 0, 1e30);

    super.deposit(assets);
}
```

### í–‰ìœ„ì ê´€ë¦¬ (Actor Management)

ìœ„ì˜ í•¨ìˆ˜ í˜¸ì¶œì—ì„œ `address(this)`ê°€ ERC-4626 ì»¨íŠ¸ë™íŠ¸ì˜ ìœ ì¼í•œ ì˜ˆê¸ˆìì„ì„ ì•Œ ìˆ˜ ìˆëŠ”ë°, ì´ëŠ” ì˜ë„ëœ ì‚¬ìš©ì˜ í˜„ì‹¤ì ì¸ í‘œí˜„ì´ ì•„ë‹™ë‹ˆë‹¤. `forge-std`ì˜ `prank` ì¹˜íŠ¸ì½”ë“œë¥¼ í™œìš©í•˜ë©´ ê° í•¸ë“¤ëŸ¬ëŠ” í–‰ìœ„ì ì§‘í•©ì„ ê´€ë¦¬í•˜ê³  ì´ë¥¼ ì‚¬ìš©í•˜ì—¬ ë‹¤ë¥¸ `msg.sender` ì£¼ì†Œì—ì„œ ë™ì¼í•œ í•¨ìˆ˜ í˜¸ì¶œì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ë‹¤ìŒ ìˆ˜ì •ì(modifier)ë¥¼ ì‚¬ìš©í•˜ì—¬ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```solidity
address[] public actors;

address internal currentActor;

modifier useActor(uint256 actorIndexSeed) {
    currentActor = actors[bound(actorIndexSeed, 0, actors.length - 1)];
    vm.startPrank(currentActor);
    _;
    vm.stopPrank();
}
```

ì—¬ëŸ¬ í–‰ìœ„ìë¥¼ ì‚¬ìš©í•˜ë©´ ê³ ìŠ¤íŠ¸ ë³€ìˆ˜ë¥¼ ë” ì„¸ë¶„í™”í•˜ì—¬ ì‚¬ìš©í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ì•„ë˜ í•¨ìˆ˜ì—ì„œ ì…ì¦ë©ë‹ˆë‹¤:

```solidity
// Unbounded
function deposit(
    uint256 assets,
    uint256 actorIndexSeed
) public virtual useActor(actorIndexSeed) {
    asset.mint(currentActor, assets);

    asset.approve(address(token), assets);

    uint256 beforeBalance = asset.balanceOf(address(this));

    uint256 shares = token.deposit(assets, address(this));

    assertEq(asset.balanceOf(address(this)), beforeBalance - assets);

    sumBalanceOf += shares;

    sumDeposits[currentActor] += assets
}
```

```solidity
// Bounded
function deposit(uint256 assets, uint256 actorIndexSeed) external {
    assets = bound(assets, 0, 1e30);

    super.deposit(assets, actorIndexSeed);
}
```
